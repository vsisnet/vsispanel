<?php

declare(strict_types=1);

namespace App\Modules\Firewall\Services;

use App\Modules\Domain\Models\Domain;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Process;

class MalwareScanService
{
    protected string $quarantineDir = '/var/vsispanel/quarantine';
    protected string $scanLogDir = '/var/vsispanel/logs/scans';

    public function __construct()
    {
        // Ensure directories exist
        if (!is_dir($this->quarantineDir)) {
            mkdir($this->quarantineDir, 0700, true);
        }
        if (!is_dir($this->scanLogDir)) {
            mkdir($this->scanLogDir, 0755, true);
        }
    }

    /**
     * Get ClamAV status
     */
    public function getStatus(): array
    {
        $running = $this->isRunning();
        $version = $this->getVersion();

        return [
            'running' => $running,
            'version' => $version,
            'quarantine_count' => count($this->getQuarantinedFiles()),
            'last_definition_update' => $this->getLastDefinitionUpdate(),
        ];
    }

    /**
     * Check if ClamAV daemon is running
     */
    public function isRunning(): bool
    {
        $result = Process::run('sudo systemctl is-active clamav-daemon');
        return $result->successful() && str_contains($result->output(), 'active');
    }

    /**
     * Get ClamAV version
     */
    public function getVersion(): ?string
    {
        $result = Process::run('clamscan --version');

        if ($result->successful()) {
            $output = trim($result->output());
            if (preg_match('/ClamAV\s+([\d.]+)/', $output, $matches)) {
                return $matches[1];
            }
            return $output;
        }

        return null;
    }

    /**
     * Get last definition update time
     */
    public function getLastDefinitionUpdate(): ?string
    {
        $dbPath = '/var/lib/clamav/daily.cld';
        if (!file_exists($dbPath)) {
            $dbPath = '/var/lib/clamav/daily.cvd';
        }

        if (file_exists($dbPath)) {
            return date('Y-m-d H:i:s', filemtime($dbPath));
        }

        return null;
    }

    /**
     * Scan a specific path
     */
    public function scanPath(string $path): array
    {
        if (!file_exists($path)) {
            return [
                'success' => false,
                'error' => 'Path does not exist',
            ];
        }

        $scanId = uniqid('scan_');
        $logFile = "{$this->scanLogDir}/{$scanId}.log";

        Log::info('Starting malware scan', ['path' => $path, 'scan_id' => $scanId]);

        // Run clamscan
        $result = Process::timeout(3600)->run(
            "clamscan -ri --log={$logFile} " . escapeshellarg($path)
        );

        $output = $result->output();
        $exitCode = $result->exitCode();

        // Parse results
        $scanResult = $this->parseScanOutput($output);
        $scanResult['scan_id'] = $scanId;
        $scanResult['path'] = $path;
        $scanResult['exit_code'] = $exitCode;
        $scanResult['log_file'] = $logFile;

        // Exit code 1 means virus found
        $scanResult['success'] = $exitCode === 0 || $exitCode === 1;
        $scanResult['clean'] = $exitCode === 0;

        Log::info('Malware scan completed', [
            'scan_id' => $scanId,
            'infected_count' => $scanResult['infected_count'],
        ]);

        return $scanResult;
    }

    /**
     * Parse clamscan output
     */
    protected function parseScanOutput(string $output): array
    {
        $result = [
            'scanned_files' => 0,
            'infected_count' => 0,
            'infected_files' => [],
            'data_scanned' => '0 MB',
            'time' => '0 sec',
        ];

        // Parse infected files
        preg_match_all('/^(.+): (.+) FOUND$/m', $output, $matches, PREG_SET_ORDER);
        foreach ($matches as $match) {
            $result['infected_files'][] = [
                'path' => $match[1],
                'threat' => $match[2],
            ];
        }

        // Parse summary
        if (preg_match('/Scanned files:\s*(\d+)/', $output, $m)) {
            $result['scanned_files'] = (int)$m[1];
        }

        if (preg_match('/Infected files:\s*(\d+)/', $output, $m)) {
            $result['infected_count'] = (int)$m[1];
        }

        if (preg_match('/Data scanned:\s*([\d.]+ \w+)/', $output, $m)) {
            $result['data_scanned'] = $m[1];
        }

        if (preg_match('/Time:\s*([\d.]+ \w+)/', $output, $m)) {
            $result['time'] = $m[1];
        }

        return $result;
    }

    /**
     * Scan a domain's document root
     */
    public function scanDomain(Domain $domain): array
    {
        $path = $domain->getDocumentRoot();

        if (!$path || !file_exists($path)) {
            return [
                'success' => false,
                'error' => 'Domain document root does not exist',
            ];
        }

        $result = $this->scanPath($path);
        $result['domain_id'] = $domain->id;
        $result['domain_name'] = $domain->name;

        return $result;
    }

    /**
     * Quarantine a file
     */
    public function quarantineFile(string $path): array
    {
        if (!file_exists($path)) {
            return [
                'success' => false,
                'error' => 'File does not exist',
            ];
        }

        $filename = basename($path);
        $quarantineId = uniqid('q_');
        $quarantinePath = "{$this->quarantineDir}/{$quarantineId}_{$filename}";

        // Create metadata file
        $metadata = [
            'original_path' => $path,
            'quarantine_date' => now()->toIso8601String(),
            'quarantine_id' => $quarantineId,
            'file_size' => filesize($path),
            'file_hash' => md5_file($path),
        ];

        // Move file to quarantine
        if (!rename($path, $quarantinePath)) {
            return [
                'success' => false,
                'error' => 'Failed to move file to quarantine',
            ];
        }

        // Save metadata
        file_put_contents(
            "{$quarantinePath}.meta",
            json_encode($metadata, JSON_PRETTY_PRINT)
        );

        Log::warning('File quarantined', [
            'original_path' => $path,
            'quarantine_path' => $quarantinePath,
        ]);

        return [
            'success' => true,
            'quarantine_id' => $quarantineId,
            'quarantine_path' => $quarantinePath,
        ];
    }

    /**
     * Restore a file from quarantine
     */
    public function restoreFile(string $quarantineId): array
    {
        $files = glob("{$this->quarantineDir}/{$quarantineId}_*");

        if (empty($files)) {
            return [
                'success' => false,
                'error' => 'Quarantined file not found',
            ];
        }

        $quarantinePath = $files[0];
        $metaPath = "{$quarantinePath}.meta";

        if (!file_exists($metaPath)) {
            return [
                'success' => false,
                'error' => 'Metadata file not found',
            ];
        }

        $metadata = json_decode(file_get_contents($metaPath), true);
        $originalPath = $metadata['original_path'];

        // Ensure parent directory exists
        $parentDir = dirname($originalPath);
        if (!is_dir($parentDir)) {
            mkdir($parentDir, 0755, true);
        }

        // Move file back
        if (!rename($quarantinePath, $originalPath)) {
            return [
                'success' => false,
                'error' => 'Failed to restore file',
            ];
        }

        // Remove metadata file
        unlink($metaPath);

        Log::info('File restored from quarantine', [
            'quarantine_id' => $quarantineId,
            'original_path' => $originalPath,
        ]);

        return [
            'success' => true,
            'restored_path' => $originalPath,
        ];
    }

    /**
     * Delete a quarantined file permanently
     */
    public function deleteQuarantinedFile(string $quarantineId): array
    {
        $files = glob("{$this->quarantineDir}/{$quarantineId}_*");

        if (empty($files)) {
            return [
                'success' => false,
                'error' => 'Quarantined file not found',
            ];
        }

        $quarantinePath = $files[0];
        $metaPath = "{$quarantinePath}.meta";

        unlink($quarantinePath);
        if (file_exists($metaPath)) {
            unlink($metaPath);
        }

        Log::info('Quarantined file deleted', ['quarantine_id' => $quarantineId]);

        return ['success' => true];
    }

    /**
     * Get all quarantined files
     */
    public function getQuarantinedFiles(): array
    {
        $files = glob("{$this->quarantineDir}/*.meta");
        $quarantined = [];

        foreach ($files as $metaFile) {
            $metadata = json_decode(file_get_contents($metaFile), true);
            $quarantinePath = str_replace('.meta', '', $metaFile);

            if ($metadata && file_exists($quarantinePath)) {
                $quarantined[] = array_merge($metadata, [
                    'quarantine_path' => $quarantinePath,
                    'exists' => true,
                ]);
            }
        }

        return $quarantined;
    }

    /**
     * Update virus definitions
     */
    public function updateDefinitions(): array
    {
        Log::info('Updating ClamAV definitions');

        $result = Process::timeout(600)->run('sudo freshclam');

        if ($result->successful()) {
            Log::info('ClamAV definitions updated');
            return [
                'success' => true,
                'message' => 'Virus definitions updated successfully',
                'output' => $result->output(),
            ];
        }

        return [
            'success' => false,
            'error' => $result->errorOutput() ?: 'Failed to update definitions',
        ];
    }

    /**
     * Get recent scan results
     */
    public function getRecentScans(int $limit = 10): array
    {
        $logFiles = glob("{$this->scanLogDir}/scan_*.log");
        rsort($logFiles); // Most recent first

        $scans = [];
        foreach (array_slice($logFiles, 0, $limit) as $logFile) {
            $scanId = basename($logFile, '.log');
            $content = file_get_contents($logFile);
            $result = $this->parseScanOutput($content);

            $scans[] = [
                'scan_id' => $scanId,
                'date' => date('Y-m-d H:i:s', filemtime($logFile)),
                'infected_count' => $result['infected_count'],
                'scanned_files' => $result['scanned_files'],
            ];
        }

        return $scans;
    }
}
