<?php

declare(strict_types=1);

namespace App\Modules\Firewall\Http\Controllers;

use App\Http\Controllers\Controller;
use App\Modules\Domain\Models\Domain;
use App\Modules\Firewall\Services\MalwareScanService;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;

class MalwareScanController extends Controller
{
    public function __construct(
        protected MalwareScanService $malwareScanService
    ) {}

    /**
     * Get scanner status
     */
    public function status(): JsonResponse
    {
        $status = $this->malwareScanService->getStatus();

        return response()->json([
            'success' => true,
            'data' => $status,
        ]);
    }

    /**
     * Scan a specific path
     */
    public function scanPath(Request $request): JsonResponse
    {
        $request->validate([
            'path' => 'required|string',
        ]);

        $result = $this->malwareScanService->scanPath($request->input('path'));

        return response()->json([
            'success' => $result['success'],
            'data' => $result,
        ]);
    }

    /**
     * Scan a domain
     */
    public function scanDomain(Domain $domain): JsonResponse
    {
        $result = $this->malwareScanService->scanDomain($domain);

        return response()->json([
            'success' => $result['success'],
            'data' => $result,
        ]);
    }

    /**
     * Get recent scans
     */
    public function recentScans(Request $request): JsonResponse
    {
        $limit = $request->input('limit', 10);
        $scans = $this->malwareScanService->getRecentScans((int)$limit);

        return response()->json([
            'success' => true,
            'data' => $scans,
        ]);
    }

    /**
     * Get quarantined files
     */
    public function quarantine(): JsonResponse
    {
        $files = $this->malwareScanService->getQuarantinedFiles();

        return response()->json([
            'success' => true,
            'data' => $files,
        ]);
    }

    /**
     * Quarantine a file
     */
    public function quarantineFile(Request $request): JsonResponse
    {
        $request->validate([
            'path' => 'required|string',
        ]);

        $result = $this->malwareScanService->quarantineFile($request->input('path'));

        if ($result['success']) {
            return response()->json([
                'success' => true,
                'message' => 'File quarantined successfully',
                'data' => $result,
            ]);
        }

        return response()->json([
            'success' => false,
            'error' => [
                'code' => 'QUARANTINE_FAILED',
                'message' => $result['error'],
            ],
        ], 500);
    }

    /**
     * Restore a quarantined file
     */
    public function restore(string $quarantineId): JsonResponse
    {
        $result = $this->malwareScanService->restoreFile($quarantineId);

        if ($result['success']) {
            return response()->json([
                'success' => true,
                'message' => 'File restored successfully',
                'data' => $result,
            ]);
        }

        return response()->json([
            'success' => false,
            'error' => [
                'code' => 'RESTORE_FAILED',
                'message' => $result['error'],
            ],
        ], 500);
    }

    /**
     * Delete a quarantined file
     */
    public function deleteQuarantined(string $quarantineId): JsonResponse
    {
        $result = $this->malwareScanService->deleteQuarantinedFile($quarantineId);

        if ($result['success']) {
            return response()->json([
                'success' => true,
                'message' => 'File deleted permanently',
            ]);
        }

        return response()->json([
            'success' => false,
            'error' => [
                'code' => 'DELETE_FAILED',
                'message' => $result['error'],
            ],
        ], 500);
    }

    /**
     * Update virus definitions
     */
    public function updateDefinitions(): JsonResponse
    {
        $result = $this->malwareScanService->updateDefinitions();

        if ($result['success']) {
            return response()->json([
                'success' => true,
                'message' => $result['message'],
            ]);
        }

        return response()->json([
            'success' => false,
            'error' => [
                'code' => 'UPDATE_FAILED',
                'message' => $result['error'],
            ],
        ], 500);
    }
}
